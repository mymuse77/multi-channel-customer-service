# ğŸ“± WhatsApp Business API é›†æˆæŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£æŒ‡å¯¼å¦‚ä½•é…ç½®å’Œä½¿ç”¨WhatsApp Business APIé›†æˆåŠŸèƒ½ã€‚

## ğŸ”§ åŠŸèƒ½ç‰¹æ€§

### å·²å®ç°åŠŸèƒ½
- âœ… **æ¶ˆæ¯å‘é€**ï¼šæ–‡æœ¬ã€æ¨¡æ¿æ¶ˆæ¯
- âœ… **Webhookæ¥æ”¶**ï¼šå®æ—¶æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯
- âœ… **æ¨¡æ‹Ÿæ¨¡å¼**ï¼šæ— éœ€çœŸå®APIå¯†é’¥çš„å¼€å‘æµ‹è¯•
- âœ… **å¥åº·æ£€æŸ¥**ï¼šæœåŠ¡çŠ¶æ€ç›‘æ§
- âœ… **æ¶ˆæ¯çŠ¶æ€æŸ¥è¯¢**ï¼šå‘é€çŠ¶æ€è·Ÿè¸ª

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹
- æ–‡æœ¬æ¶ˆæ¯
- æ¨¡æ¿æ¶ˆæ¯
- å›¾ç‰‡æ¶ˆæ¯ï¼ˆè§£æï¼‰
- éŸ³é¢‘æ¶ˆæ¯ï¼ˆè§£æï¼‰
- æ–‡æ¡£æ¶ˆæ¯ï¼ˆè§£æï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¼€å‘ç¯å¢ƒï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰
æ— éœ€é…ç½®ï¼Œç›´æ¥ä½¿ç”¨ï¼š

```bash
# å¯åŠ¨åç«¯æœåŠ¡
cd backend
uvicorn app.main:app --reload --port 8000
```

è®¿é—®APIæ–‡æ¡£ï¼šhttp://localhost:8000/docs

### 2. ç”Ÿäº§ç¯å¢ƒé…ç½®

#### æ­¥éª¤1ï¼šè·å–WhatsApp Business APIè®¿é—®æƒé™
1. è®¿é—® [Meta for Developers](https://developers.facebook.com/)
2. åˆ›å»ºåº”ç”¨æˆ–ä½¿ç”¨ç°æœ‰åº”ç”¨
3. æ·»åŠ WhatsAppäº§å“
4. è·å–ç³»ç»Ÿç”¨æˆ·è®¿é—®ä»¤ç‰Œ

#### æ­¥éª¤2ï¼šé…ç½®ç¯å¢ƒå˜é‡
åˆ›å»º `.env` æ–‡ä»¶ï¼š
```bash
# WhatsAppé…ç½®
WHATSAPP_API_TOKEN=ä½ çš„è®¿é—®ä»¤ç‰Œ
WHATSAPP_PHONE_NUMBER_ID=ä½ çš„ç”µè¯å·ç ID
```

#### æ­¥éª¤3ï¼šé…ç½®Webhook
1. åœ¨Metaå¼€å‘è€…æ§åˆ¶å°é…ç½®Webhook URLï¼š
   ```
   https://ä½ çš„åŸŸå/api/v1/whatsapp/webhook
   ```
2. è®¾ç½®éªŒè¯ä»¤ç‰Œ
3. è®¢é˜…æ‰€éœ€å­—æ®µ

## ğŸ“¡ APIç«¯ç‚¹

### 1. å‘é€æ¶ˆæ¯
```http
POST /api/v1/whatsapp/send
```
å‚æ•°ï¼š
- `to`: æ¥æ”¶è€…ç”µè¯å·ç ï¼ˆ8613800138000ï¼‰
- `message`: æ¶ˆæ¯å†…å®¹
- `message_type`: æ¶ˆæ¯ç±»å‹ï¼ˆé»˜è®¤textï¼‰

### 2. å‘é€æ¨¡æ¿æ¶ˆæ¯
```http
POST /api/v1/whatsapp/send-template
```
å‚æ•°ï¼š
- `to`: æ¥æ”¶è€…
- `template_name`: æ¨¡æ¿åç§°
- `language_code`: è¯­è¨€ä»£ç ï¼ˆé»˜è®¤zh_CNï¼‰

### 3. Webhookæ¥æ”¶
```http
POST /api/v1/whatsapp/webhook
```
WhatsAppä¼šå‘é€æ¶ˆæ¯åˆ°è¿™ä¸ªç«¯ç‚¹ã€‚

### 4. å¥åº·æ£€æŸ¥
```http
GET /api/v1/whatsapp/health
```

### 5. é…ç½®ä¿¡æ¯
```http
GET /api/v1/whatsapp/config
```

## ğŸ”’ å®‰å…¨é…ç½®

### WebhookéªŒè¯
ç”Ÿäº§ç¯å¢ƒéœ€è¦å®ç°ç­¾åéªŒè¯ï¼š
```python
def verify_signature(signature: str, payload: bytes) -> bool:
    # ä½¿ç”¨åº”ç”¨å¯†é’¥éªŒè¯ç­¾å
    # å‚è€ƒï¼šhttps://developers.facebook.com/docs/graph-api/webhooks/getting-started#verification-requests
    pass
```

### è®¿é—®æ§åˆ¶
å»ºè®®æ·»åŠ ï¼š
1. IPç™½åå•
2. APIå¯†é’¥è®¤è¯
3. è¯·æ±‚é¢‘ç‡é™åˆ¶

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æ¨¡æ‹Ÿæ¨¡å¼æµ‹è¯•
```bash
# ä½¿ç”¨curlæµ‹è¯•
curl -X POST "http://localhost:8000/api/v1/whatsapp/send?to=8613800138000&message=æµ‹è¯•æ¶ˆæ¯"
```

### çœŸå®APIæµ‹è¯•
1. é…ç½®çœŸå®APIå¯†é’¥
2. ä½¿ç”¨WhatsAppæµ‹è¯•å·ç 
3. éªŒè¯æ¶ˆæ¯æ”¶å‘

### è‡ªåŠ¨åŒ–æµ‹è¯•
```python
# tests/test_whatsapp.py
def test_send_message_simulation():
    result = await whatsapp_service.send_message("8613800138000", "æµ‹è¯•")
    assert result["success"] == True
    assert "message_id" in result
```

## ğŸ”„ æ¶ˆæ¯æµç¨‹

### å‘é€æµç¨‹
```
ç”¨æˆ·è¯·æ±‚ â†’ APIéªŒè¯ â†’ æ„å»ºæ¶ˆæ¯ â†’ è°ƒç”¨WhatsApp API â†’ è¿”å›ç»“æœ
```

### æ¥æ”¶æµç¨‹
```
WhatsApp Webhook â†’ ç­¾åéªŒè¯ â†’ è§£ææ¶ˆæ¯ â†’ å­˜å‚¨åˆ°æ•°æ®åº“ â†’ è§¦å‘ä¸šåŠ¡é€»è¾‘
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å…³é”®æŒ‡æ ‡
- æ¶ˆæ¯å‘é€æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- Webhookæ¥æ”¶é¢‘ç‡
- é”™è¯¯ç‡

### æ—¥å¿—è®°å½•
```python
logger.info(f"å‘é€æ¶ˆæ¯åˆ° {to}: {message[:50]}...")
logger.error(f"æ¶ˆæ¯å‘é€å¤±è´¥: {error}")
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ¶ˆæ¯å‘é€å¤±è´¥
**å¯èƒ½åŸå› **ï¼š
- APIä»¤ç‰Œæ— æ•ˆ
- ç”µè¯å·ç IDé”™è¯¯
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- éªŒè¯APIé…ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

#### 2. Webhookæœªæ¥æ”¶
**å¯èƒ½åŸå› **ï¼š
- URLé…ç½®é”™è¯¯
- ç­¾åéªŒè¯å¤±è´¥
- ç½‘ç»œé˜²ç«å¢™

**è§£å†³æ–¹æ¡ˆ**ï¼š
- éªŒè¯Webhook URL
- æ£€æŸ¥ç­¾åç®—æ³•
- æµ‹è¯•ç½‘ç»œè¿é€šæ€§

#### 3. æ¨¡æ‹Ÿæ¨¡å¼åˆ‡æ¢
**ä»æ¨¡æ‹Ÿåˆ‡æ¢åˆ°çœŸå®**ï¼š
1. é…ç½®ç¯å¢ƒå˜é‡
2. é‡å¯æœåŠ¡
3. éªŒè¯è¿æ¥

### é”™è¯¯ä»£ç 
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401`: è®¤è¯å¤±è´¥
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

## ğŸ”— ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [WhatsApp Business APIæ–‡æ¡£](https://developers.facebook.com/docs/whatsapp/cloud-api)
- [Webhooké…ç½®æŒ‡å—](https://developers.facebook.com/docs/graph-api/webhooks)
- [æ¶ˆæ¯æ¨¡æ¿æŒ‡å—](https://developers.facebook.com/docs/whatsapp/business-management-api/message-templates)

### å¼€å‘å·¥å…·
- [Metaå¼€å‘è€…æ§åˆ¶å°](https://developers.facebook.com/apps/)
- [WhatsApp APIæµ‹è¯•å·¥å…·](https://developers.facebook.com/tools/explorer/)
- [Webhookæµ‹è¯•å·¥å…·](https://webhook.site/)

### ç¤¾åŒºæ”¯æŒ
- [Metaå¼€å‘è€…ç¤¾åŒº](https://developers.facebook.com/community/)
- [GitHub Issues](https://github.com/mymuse77/multi-channel-customer-service/issues)

## ğŸ“ˆ æœ€ä½³å®è·µ

### 1. æ¶ˆæ¯è®¾è®¡
- ä¿æŒæ¶ˆæ¯ç®€æ´
- ä½¿ç”¨æ¨¡æ¿æé«˜æ•ˆç‡
- æ·»åŠ ä¸ªæ€§åŒ–å†…å®¹

### 2. é”™è¯¯å¤„ç†
- å®ç°é‡è¯•æœºåˆ¶
- è®°å½•è¯¦ç»†æ—¥å¿—
- è®¾ç½®å‘Šè­¦é€šçŸ¥

### 3. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨å¼‚æ­¥å¤„ç†
- å®ç°æ¶ˆæ¯é˜Ÿåˆ—
- ç¼“å­˜å¸¸ç”¨æ•°æ®

### 4. åˆè§„æ€§
- éµå®ˆWhatsAppæ”¿ç­–
- è·å–ç”¨æˆ·åŒæ„
- æä¾›é€€è®¢é€‰é¡¹

## ğŸš€ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

### çŸ­æœŸç›®æ ‡
- [ ] å®ç°æ¶ˆæ¯é˜Ÿåˆ—
- [ ] æ·»åŠ æ¶ˆæ¯æ¨¡æ¿ç®¡ç†
- [ ] å®Œå–„é”™è¯¯å¤„ç†

### ä¸­æœŸç›®æ ‡
- [ ] å®ç°ç¾¤å‘åŠŸèƒ½
- [ ] æ·»åŠ åª’ä½“æ¶ˆæ¯æ”¯æŒ
- [ ] é›†æˆæ¶ˆæ¯åˆ†æ

### é•¿æœŸç›®æ ‡
- [ ] å®ç°AIè‡ªåŠ¨å›å¤
- [ ] æ·»åŠ å¤šæ¸ é“è·¯ç”±
- [ ] æ„å»ºç®¡ç†é¢æ¿

---

**æœ€åæ›´æ–°**: 2026å¹´2æœˆ23æ—¥  
**ç‰ˆæœ¬**: 1.0.0  
**ç»´æŠ¤è€…**: å°Z (AIåŠ©æ‰‹)